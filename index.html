<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Biolo-Gio | Enciclopedia (v4)</title>
<meta name="description" content="Enciclopedia degli animali: habitat, dieta, comportamento. Ricerca, filtri, sfondi con texture e schede premium con testi lunghi." />
<style>
  :root{
    --panel:#fff; --muted:#475569; --text:#0f172a; --ring:#22d3ee55; --radius:18px;
    --t0:#ffffff; --t1:#f1f5f9;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; color:var(--text); background:#f1f5f9; line-height:1.6;}

  header{position:sticky; top:0; z-index:50; backdrop-filter:saturate(120%) blur(10px); background:linear-gradient(180deg,#ffffffee,#ffffffcc); border-bottom:1px solid #e2e8f0}
  .wrap{max-width:1180px; margin:auto; padding:16px}
  .topbar{display:flex; align-items:center; gap:16px}
  .logo{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
  .logo .mark{width:38px;height:38px;border-radius:12px;display:grid;place-items:center; background:conic-gradient(from 210deg,#06b6d4,#8b5cf6 40%,#10b981); box-shadow:0 0 0 4px #00000005 inset, 0 10px 30px #0001;}
  .logo b{font-size:20px}
  nav{margin-left:auto; display:flex; gap:14px; flex-wrap:wrap}
  nav a{color:var(--muted); text-decoration:none; padding:8px 12px; border-radius:10px}
  nav a:hover{color:var(--text); background:#e2e8f0}

  .hero{display:grid; gap:4px; padding:24px 0 8px}
  .hero h1{margin:0; font-size:clamp(28px,4vw,44px)}
  .hero p{margin:0; color:var(--muted)}

  .panel{background:var(--panel); border:1px solid #e2e8f0; border-radius:var(--radius); box-shadow:0 8px 30px #0000000d}
  .panel.pad{padding:16px}

  .controls{display:grid; grid-template-columns:1fr 200px; gap:12px; align-items:center}
  .search{position:relative}
  .search input{width:100%; padding:14px 44px 14px 14px; border-radius:12px; border:1px solid #cbd5e1; background:#fff; color:#0f172a}
  .search input:focus{outline:none; box-shadow:0 0 0 6px var(--ring)}
  .search .icon{position:absolute; right:12px; top:50%; transform:translateY(-50%); opacity:.6}
  select{width:100%; padding:14px; border-radius:12px; border:1px solid #cbd5e1; background:#fff; color:#0f172a}

  .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(240px,1fr)); gap:16px; margin-top:16px}
  .card{background:#fff; border:1px solid #e2e8f0; border-radius:16px; overflow:hidden; transition:transform .15s, box-shadow .15s}
  .card:hover{transform:translateY(-4px); box-shadow:0 12px 30px #00000014}
  .thumb{height:160px; display:grid; place-items:center; font-size:72px; position:relative; overflow:hidden}
  .thumb::after{content:""; position:absolute; inset:0; background-image:
      repeating-linear-gradient(45deg, rgba(255,255,255,.28) 0 8px, transparent 8px 16px),
      repeating-radial-gradient( circle at 20% 30%, rgba(0,0,0,.06) 0 1.8px, transparent 1.8px 10px);
    background-size:200px 200px, 160px 160px; mix-blend-mode:soft-light; pointer-events:none;}
  .thumb .emoji{position:relative; z-index:1; filter:drop-shadow(0 2px 6px rgba(0,0,0,.12))}

  /* banner habitat */
  .hab-foresta{background-image:linear-gradient(135deg,#dcfce7,#bbf7d0)}
  .hab-savana{background-image:linear-gradient(135deg,#fef9c3,#fde68a)}
  .hab-oceano{background-image:linear-gradient(135deg,#e0f2fe,#bae6fd)}
  .hab-montagna{background-image:linear-gradient(135deg,#e2e8f0,#cbd5e1)}
  .hab-ghiaccio{background-image:linear-gradient(135deg,#f1f5f9,#e0f2fe)}
  .hab-deserto{background-image:linear-gradient(135deg,#ffedd5,#fed7aa)}
  .hab-prateria{background-image:linear-gradient(135deg,#d1fae5,#a7f3d0)}

  .badge{display:inline-block; padding:4px 8px; border:1px solid #c7d2fe; border-radius:999px; font-size:12px; color:#4338ca; background:#eef2ff}
  .card .body{padding:12px 14px}
  .card h3{margin:0 0 6px; font-size:18px}
  .meta{font-size:13px; color:#475569}
  .btn{appearance:none; border:none; padding:10px 12px; border-radius:10px; background:#dbf4ff; color:#0c4a6e; cursor:pointer; text-decoration:none; display:inline-flex; gap:8px; align-items:center}
  .btn:hover{background:#bae6fd}

  .detail{margin-top:24px; display:grid; grid-template-columns:1.6fr 0.9fr; gap:18px}
  .hero-animal{border-radius:16px; overflow:hidden; position:relative; border:1px solid #e2e8f0}
  .hero-animal .banner{height:180px; display:grid; place-items:center; font-size:96px}
  .hero-animal .head{display:flex; gap:16px; align-items:center; padding:12px 16px}
  .quick{position:sticky; top:90px; align-self:start}
  .quick .kv{display:grid; grid-template-columns:auto 1fr; gap:8px 12px; font-size:14px}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#f1f5f9; border:1px solid #e2e8f0; font-size:12px}

  .toc{display:flex; flex-wrap:wrap; gap:8px; padding:8px 0}
  .toc a{padding:6px 10px; border:1px solid #e2e8f0; border-radius:999px; text-decoration:none; color:#334155; background:#fff}
  .toc a:hover{background:#f8fafc}

  details.acc{border:1px solid #e2e8f0; border-radius:12px; background:#fff; margin:14px 0; overflow:hidden}
  details.acc[open]{box-shadow:0 8px 24px #0000000d}
  summary.acc-sum{list-style:none; cursor:pointer; padding:12px 14px; display:flex; align-items:center; gap:10px; font-weight:600}
  summary.acc-sum .chev{transition:transform .2s; opacity:.7}
  details[open] summary.acc-sum .chev{transform:rotate(90deg)}
  .acc-body{padding:0 14px 14px}
  .callout{background:#ecfeff; border:1px solid #bae6fd; padding:10px 12px; border-radius:12px; font-size:14px}

  .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(40px);background:linear-gradient(135deg,#06b6d4,#8b5cf6);color:#fff;padding:10px 18px;border-radius:12px;box-shadow:0 8px 30px #00000026;opacity:0;pointer-events:none;transition:opacity .35s, transform .35s;z-index:9999}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* Pattern di sfondo globale con colori per tema */
  @keyframes drift {0%{background-position:0 0,0 0,0 0,200px 200px}100%{background-position:0 0,0 0,0 0,400px 400px}}
  body[class*="theme-"]{
    background-attachment:fixed;
    background-image:
      linear-gradient(180deg, var(--t0), var(--t1) 60%),
      radial-gradient(900px 700px at 110% 0%, rgba(255,255,255,.45), transparent),
      repeating-radial-gradient(circle at 25% 25%, rgba(0,0,0,.06) 0 2px, transparent 2px 12px),
      repeating-linear-gradient(135deg, rgba(0,0,0,.05) 0 10px, transparent 10px 22px);
    background-size:auto,auto,140px 140px,160px 160px!important;
    background-blend-mode:normal,normal,overlay,overlay; animation:drift 120s linear infinite;
  }
</style>
</head>
<body>
<header>
  <div class="wrap topbar">
    <a class="logo" href="#/home"><div class="mark">üß¨</div><b>Biolo-Gio</b></a>
    <nav><a href="#/home">Home</a><a href="#/animali">Animali</a><a href="#/curiosita">Curiosit√†</a><a href="#/contatti">Contatti</a></nav>
  </div>
</header>

<main class="wrap">
  <section class="hero">
    <h1>Biolo-Gio v4 ‚Äî pi√π specie, pi√π premium, stessa chiarezza</h1>
    <p>Descrizione sempre visibile; le altre sezioni si aprono a clic. Sfondi ispirati agli habitat con texture leggere.</p>
  </section>

  <section class="panel pad" id="controls">
    <div class="controls">
      <label class="search">
        <input id="q" placeholder="Cerca per nome, habitat, dieta‚Ä¶ (es. ‚Äòfalco‚Äô, ‚Äòsavana‚Äô, ‚Äòinsettivoro‚Äô)" autocomplete="off" />
        <span class="icon">üîé</span>
      </label>
      <label>
        <select id="filterClass">
          <option value="">Tutte le classi</option>
          <option>Mammiferi</option><option>Uccelli</option><option>Rettili</option>
          <option>Anfibi</option><option>Pesci</option><option>Invertebrati</option>
        </select>
      </label>
    </div>
    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" id="btnRandom">üé≤ Animale casuale</button>
      <span class="meta">Premi <kbd>R</kbd> per pescarne uno a caso.</span>
    </div>
  </section>

  <section id="view"></section>

  <footer class="wrap" style="margin:30px 0 60px; color:#475569">
    Progetto <b>Biolo-Gio</b>. Tutto in un file, pronto per GitHub Pages.
  </footer>
</main>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ===== UTIL ===== */
const slug = s => s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
const by = key => (a,b)=> (a[key]||"").localeCompare(b[key]||"");
const qs = sel => document.querySelector(sel);
const state = { q:"", cls:"", route:"/home" };
function showToast(msg){ const t = document.querySelector('#toast'); t.textContent = msg; t.classList.add('show'); clearTimeout(showToast._t); showToast._t = setTimeout(()=> t.classList.remove('show'), 2000); }

/* ===== THEME ===== */
const THEMES = ['theme-foresta','theme-savana','theme-oceano','theme-montagna','theme-ghiaccio','theme-deserto','theme-prateria'];
function applyTheme(theme){
  const map = {
    "theme-foresta": ["#f0fdf4", "#dcfce7"],
    "theme-savana":  ["#fffbeb", "#fef9c3"],
    "theme-oceano":  ["#f0f9ff", "#e0f2fe"],
    "theme-montagna":["#f8fafc", "#e2e8f0"],
    "theme-ghiaccio":["#f8fafc", "#e0f2fe"],
    "theme-deserto": ["#fff7ed", "#ffedd5"],
    "theme-prateria":["#ecfeff", "#d1fae5"]
  };
  document.body.classList.remove(...THEMES);
  document.body.classList.add(theme);
  const [t0, t1] = map[theme] || map["theme-prateria"];
  document.documentElement.style.setProperty('--t0', t0);
  document.documentElement.style.setProperty('--t1', t1);
}

/* ===== LITE TEXTS ===== */
const EMOJI_BY_CLASS = { "Mammiferi":"ü¶å", "Uccelli":"üê¶", "Rettili":"ü¶é", "Anfibi":"üê∏", "Pesci":"üêü", "Invertebrati":"ü™≤" };
const TEMPLATES = {
  desc: ({name, habitat, cls}) => `${name} vive soprattutto in ${habitat.toLowerCase()}. √à un tipico rappresentante dei ${cls.toLowerCase()}, con adattamenti pratici all‚Äôambiente e alla dieta.`,
  soc : ({name, cls}) => `La socialit√† di ${name} rientra nei ${cls.toLowerCase()}: pi√π territoriale in riproduzione, pi√π tollerante quando cibo e ripari abbondano.`,
  feed: ({diet}) => `Dieta: ${diet.toLowerCase()}. L‚Äôattivit√† segue le ore migliori (alba/crepuscolo) e i microhabitat favorevoli.`,
  repr: ({name}) => `Corteggiamenti specifici e cure parentali variabili; i giovani di ${name} apprendono presto rifugi sicuri e fonti locali di cibo.`,
  eco : ({name}) => `${name} contribuisce all‚Äôequilibrio: controlla prede/competitori o disperde semi; a sua volta √® risorsa per predatori superiori.`,
  hum : ({habitat}) => `Rischi: frammentazione di ${habitat.toLowerCase()}, traffico, inquinamento, disturbo. Utili corridoi ecologici e tutela dei siti riproduttivi.`
};
function expandLite([name, scientificName, cls, emoji, habitat, diet]){
  const base = { name, scientificName, class:cls, emoji: emoji || EMOJI_BY_CLASS[cls] || "üß¨", habitat, diet, lifespan:"‚Äî", size:"‚Äî", conservation:"‚Äî" };
  const ctx = { name, habitat, cls };
  return { ...base,
    description:TEMPLATES.desc(ctx), sociality:TEMPLATES.soc(ctx), feeding:TEMPLATES.feed({diet}),
    reproduction:TEMPLATES.repr(ctx), interactions:TEMPLATES.eco(ctx), human:TEMPLATES.hum({habitat}),
    facts:["Adattabile","Ruolo ecologico rilevante","Convivenza possibile"] };
}
const habClass = (hab='')=>{
  const h = (hab||'').toLowerCase();
  if(h.includes('foreste')||h.includes('foresta')||h.includes('bosco')) return 'hab-foresta';
  if(h.includes('savana')||h.includes('prateria')||h.includes('steppe')) return 'hab-savana';
  if(h.includes('antart')||h.includes('ghiaccio')||h.includes('polo')) return 'hab-ghiaccio';
  if(h.includes('mare')||h.includes('oceano')||h.includes('coste')||h.includes('acque')) return 'hab-oceano';
  if(h.includes('monta')||h.includes('scoglier')||h.includes('alp')) return 'hab-montagna';
  if(h.includes('deserto')||h.includes('arido')||h.includes('sabbia')) return 'hab-deserto';
  return 'hab-prateria';
};
const toTheme = hc=>({ 'hab-foresta':'theme-foresta','hab-savana':'theme-savana','hab-ghiaccio':'theme-ghiaccio','hab-oceano':'theme-oceano','hab-montagna':'theme-montagna','hab-deserto':'theme-deserto','hab-prateria':'theme-prateria' }[hc]||'theme-prateria');

/* ===== DATASET LITE BASE (da v3) ===== */
const BASE_BULK = [
  // (riassunto compatto: v3 gi√† includeva ~90; teniamo una selezione ampia)
  ["Leone","Panthera leo","Mammiferi","ü¶Å","savana africana","carnivoro (ungulati)"],
  ["Tigre","Panthera tigris","Mammiferi","üêØ","foreste e paludi asiatiche","carnivoro"],
  ["Ghepardo","Acinonyx jubatus","Mammiferi","üêÜ","savana","carnivoro (antilopi)"],
  ["Lupo grigio","Canis lupus","Mammiferi","üê∫","foreste e tundre","carnivoro"],
  ["Volpe rossa","Vulpes vulpes","Mammiferi","ü¶ä","campagne e citt√†","onnivoro"],
  ["Elefante africano della savana","Loxodonta africana","Mammiferi","üêò","savana e boscaglie","erbivoro"],
  ["Giraffa","Giraffa camelopardalis","Mammiferi","ü¶í","savana","erbivoro (foglie)"],
  ["Iena maculata","Crocuta crocuta","Mammiferi","ü¶¨","savana africana","carnivoro/necrofago"],
  ["Orso polare","Ursus maritimus","Mammiferi","üêª‚Äç‚ùÑÔ∏è","ghiacci artici","carnivoro (foche)"],
  ["Orso bruno","Ursus arctos","Mammiferi","üêª","foreste e montagne","onnivoro"],
  ["Panda gigante","Ailuropoda melanoleuca","Mammiferi","üêº","foreste di bamb√π","erbivoro (bamb√π)"],
  ["Panda rosso","Ailurus fulgens","Mammiferi","ü¶ä","foreste himalayane","onnivoro (bamb√π, frutta)"],
  ["Koala","Phascolarctos cinereus","Mammiferi","üê®","foreste di eucalipto","erbivoro"],
  ["Canguro rosso","Osphranter rufus","Mammiferi","ü¶ò","zone aride australiane","erbivoro"],
  ["Capibara","Hydrochoerus hydrochaeris","Mammiferi","ü´é","zone umide sudamericane","erbivoro"],
  ["Lontra europea","Lutra lutra","Mammiferi","ü¶¶","fiumi e laghi puliti","carnivoro (pesci)"],
  ["Delfino tursiope","Tursiops truncatus","Mammiferi","üê¨","coste temperate/tropicali","carnivoro (pesci)"],
  ["Orca","Orcinus orca","Mammiferi","üêã","oceani","carnivoro (pesci/mammiferi)"],
  ["Ippopotamo","Hippopotamus amphibius","Mammiferi","ü¶õ","fiumi e lagune","erbivoro notturno"],
  ["Rinoceronte bianco","Ceratotherium simum","Mammiferi","ü¶è","savana africana","erbivoro"],
  ["Bisonte europeo","Bison bonasus","Mammiferi","ü¶¨","foreste/piane europee","erbivoro"],
  ["Tasso europeo","Meles meles","Mammiferi","ü¶°","boschi e campagne","onnivoro"],
  ["Gatto domestico","Felis catus","Mammiferi","üê±","ambienti urbani e rurali","carnivoro opportunista"],
  ["Cane domestico","Canis familiaris","Mammiferi","üê∂","ambienti umani","onnivoro"],
  ["Wombat","Vombatus ursinus","Mammiferi","ü¶•","boscaglie australiane","erbivoro"],

  ["Falco pellegrino","Falco peregrinus","Uccelli","ü™∂","scogliere e citt√†","carnivoro (uccelli in volo)"],
  ["Aquila reale","Aquila chrysaetos","Uccelli","ü¶Ö","montagne e scogliere","carnivoro"],
  ["Aquila di mare coda bianca","Haliaeetus albicilla","Uccelli","ü¶Ö","laghi e coste nordiche","piscivoro"],
  ["Corvo comune","Corvus corone","Uccelli","üê¶","campagne e citt√†","onnivoro"],
  ["Pinguino imperatore","Aptenodytes forsteri","Uccelli","üêß","Antartide","piscivoro/krill"],
  ["Pinguino di Humboldt","Spheniscus humboldti","Uccelli","üêß","coste pacifiche sudamericane","piscivoro"],
  ["Fenicottero rosa","Phoenicopterus roseus","Uccelli","ü¶©","lagune salmastre","filtratore"],
  ["Airone cenerino","Ardea cinerea","Uccelli","ü™Å","zone umide","piscivoro"],
  ["Cicogna bianca","Ciconia ciconia","Uccelli","üïäÔ∏è","zone agricole/umide","onnivoro"],
  ["Martin pescatore","Alcedo atthis","Uccelli","üêü","fiumi puliti","piscivoro"],
  ["Gufo delle nevi","Bubo scandiacus","Uccelli","ü¶â","tundra","carnivoro"],
  ["Civetta","Athene noctua","Uccelli","ü¶â","campagna mediterranea","carnivoro"],
  ["Poiana comune","Buteo buteo","Uccelli","ü¶Ö","mosaico agricolo/forestale","carnivoro"],
  ["Rondine","Hirundo rustica","Uccelli","ü™Ω","rurale e urbano","insettivoro volante"],
  ["Rondone","Apus apus","Uccelli","ü™Ω","citt√† e scogliere","insettivoro volante"],
  ["Picchio verde","Picus viridis","Uccelli","ü™µ","boschi e parchi","insettivoro (formiche)"],
  ["Gabbiano reale","Larus michahellis","Uccelli","üïäÔ∏è","coste e citt√†","onnivoro"],
  ["Gallina domestica","Gallus gallus domesticus","Uccelli","üêî","rurale e urbano","onnivoro/granivoro"],
  ["Anatra reale","Anas platyrhynchos","Uccelli","ü¶Ü","stagni e fiumi","onnivoro"],

  ["Coccodrillo del Nilo","Crocodylus niloticus","Rettili","üêä","fiumi e laghi africani","carnivoro"],
  ["Coccodrillo marino","Crocodylus porosus","Rettili","üêä","estuari indo-pacifici","carnivoro"],
  ["Camaleonte comune","Chamaeleo chamaeleon","Rettili","ü¶é","macchia mediterranea","insettivoro"],
  ["Camaleonte di Jackson","Trioceros jacksonii","Rettili","ü¶é","Africa orientale","insettivoro"],
  ["Iguana verde","Iguana iguana","Rettili","ü¶é","foreste tropicali","erbivoro"],
  ["Drago di Komodo","Varanus komodoensis","Rettili","ü¶é","isole indonesiane","carnivoro"],
  ["Boa constrictor","Boa constrictor","Rettili","üêç","neotropici","carnivoro"],
  ["Pitone reale","Python regius","Rettili","üêç","savana africana","carnivoro"],
  ["Vipera comune","Vipera berus","Rettili","üêç","Europa temperata","carnivoro"],
  ["Geco tokay","Gekko gecko","Rettili","ü¶é","case/foreste tropicali","insettivoro"],
  ["Testuggine di Hermann","Testudo hermanni","Rettili","üê¢","macchia mediterranea","erbivoro"],
  ["Tartaruga caretta","Caretta caretta","Rettili","üê¢","mari temperati e spiagge","onnivoro"],
  ["Alligatore americano","Alligator mississippiensis","Rettili","üêä","paludi/fiumi USA","carnivoro"],
  ["Varano del Nilo","Varanus niloticus","Rettili","ü¶é","Africa sub-sahariana","carnivoro"],
  ["Serpente corallo","Micrurus spp.","Rettili","üêç","Americhe tropicali","carnivoro"],

  ["Raganella italiana","Hyla intermedia","Anfibi","üê∏","zone umide e siepi","insettivora"],
  ["Rana verde","Pelophylax kl. esculentus","Anfibi","üê∏","stagni e fossi","insettivora"],
  ["Rospo comune","Bufo bufo","Anfibi","üê∏","boschi/giardini umidi","insettivoro"],
  ["Salamandra pezzata","Salamandra salamandra","Anfibi","ü¶é","boschi umidi europei","insettivora"],
  ["Axolotl","Ambystoma mexicanum","Anfibi","üßú‚Äç‚ôÇÔ∏è","lagune messicane","invertebrati e piccoli pesci"],
  ["Tritone crestato","Triturus cristatus","Anfibi","ü¶é","stagni forestali","insettivoro"],
  ["Tritone punteggiato","Lissotriton vulgaris","Anfibi","ü¶é","acque calme europee","insettivoro"],
  ["Rana di Darwin","Rhinoderma darwinii","Anfibi","üê∏","Cile/Argentina umidi","insettivoro"],

  ["Squalo bianco","Carcharodon carcharias","Pesci","ü¶à","oceani temperati","carnivoro"],
  ["Tonno pinna gialla","Thunnus albacares","Pesci","üêü","oceani tropicali","carnivoro"],
  ["Manta gigante","Mobula birostris","Pesci","üõ∏","oceani tropicali","plancton"],
  ["Salmone atlantico","Salmo salar","Pesci","üêü","Atlantico + fiumi di risalita","onnivoro"],
  ["Anguilla europea","Anguilla anguilla","Pesci","üêü","acque dolci/mare dei Sargassi","onnivoro"],
  ["Cernia bruna","Epinephelus marginatus","Pesci","üêü","Mediterraneo roccioso","carnivoro"],
  ["Barracuda","Sphyraena barracuda","Pesci","üêü","barriere e coste","carnivoro"],
  ["Murena mediterranea","Muraena helena","Pesci","üêç","fondali rocciosi","carnivoro"],
  ["Pesce pagliaccio","Amphiprion ocellaris","Pesci","üê†","barriere coralline","onnivoro"],
  ["Pesce luna","Mola mola","Pesci","üåû","oceani temperati","gelatofago"],

  ["Polpo comune","Octopus vulgaris","Invertebrati","üêô","fondali rocciosi","carnivoro"],
  ["Seppia comune","Sepia officinalis","Invertebrati","ü¶ë","fondali sabbiosi","carnivoro"],
  ["Calamaro gigante","Architeuthis dux","Invertebrati","ü¶ë","abissi oceanici","carnivoro"],
  ["Ape mellifera","Apis mellifera","Invertebrati","üêù","prati e citt√†","nettare e polline"],
  ["Mantide religiosa","Mantis religiosa","Invertebrati","ü¶ó","prati e margini di campo","predatrice di insetti"],
  ["Coccinella","Coccinella septempunctata","Invertebrati","üêû","prati e campi","predatrice di afidi"],
  ["Libellula","Anisoptera spp.","Invertebrati","ü™∞","zone umide","predatrice di insetti"],
  ["Lucciola","Lampyridae spp.","Invertebrati","‚ú®","prati umidi","bioluminescenza"],
  ["Riccio di mare","Paracentrotus lividus","Invertebrati","ü¶î","praterie di Posidonia","alghe"],
  ["Stella marina comune","Asterias rubens","Invertebrati","‚≠ê","fondali rocciosi atlantici","bivalvi"]
];

/* ===== NUOVO PACCHETTO LITE (+60) ===== */
const MORE_BULK = [
  // Mammiferi
  ["Antilope gnu","Connochaetes taurinus","Mammiferi","ü¶å","savana","erbivoro"],
  ["Zebra delle pianure","Equus quagga","Mammiferi","ü¶ì","savana","erbivoro"],
  ["Gatto selvatico europeo","Felis silvestris","Mammiferi","üê±","boschi europei","carnivoro"],
  ["Volpe artica","Vulpes lagopus","Mammiferi","ü¶ä","tundra artica","onnivoro"],
  ["Lince eurasiatica","Lynx lynx","Mammiferi","ü¶Å","foreste boreali","carnivoro"],
  ["Cammello bactriano","Camelus bactrianus","Mammiferi","üê´","steppe e deserti freddi","erbivoro"],
  ["Dromedario","Camelus dromedarius","Mammiferi","üê™","deserti caldi","erbivoro"],
  ["Capra delle nevi","Oreamnos americanus","Mammiferi","üêê","montagne rocciose","erbivoro"],
  ["Stambecco alpino","Capra ibex","Mammiferi","üêê","Alpi","erbivoro"],
  ["Cinghiale","Sus scrofa","Mammiferi","üêó","boschi e campagne","onnivoro"],
  ["Istrice","Hystrix cristata","Mammiferi","ü¶î","macchia mediterranea","erbivoro"],
  ["Tapiro","Tapirus terrestris","Mammiferi","ü´è","foreste tropicali","erbivoro"],
  ["Formichiere gigante","Myrmecophaga tridactyla","Mammiferi","üêú","savane/foreste tropicali","insettivoro"],
  ["Bradipo tridattilo","Bradypus tridactylus","Mammiferi","ü¶•","foreste tropicali","erbivoro"],
  ["Fossa","Cryptoprocta ferox","Mammiferi","üêà","Madagascar","carnivoro"],
  ["Suricato","Suricata suricatta","Mammiferi","ü¶ù","deserti e semideserti","insettivoro"],
  ["Pipistrello ferro di cavallo","Rhinolophus spp.","Mammiferi","ü¶á","grotte e boschi","insettivoro"],
  ["Dingo","Canis dingo","Mammiferi","üê∂","Australia semi-arida","carnivoro"],
  ["Tamarino imperatore","Saguinus imperator","Mammiferi","üêí","foreste amazzoniche","onnivoro"],
  ["Gibbone","Hylobatidae spp.","Mammiferi","ü¶ß","foreste del Sud-Est asiatico","frugivoro"],
  // Uccelli
  ["Albatros urlatore","Diomedea exulans","Uccelli","üïäÔ∏è","oceani australi","piscivoro"],
  ["Condor delle Ande","Vultur gryphus","Uccelli","ü¶Ö","Ande","necrofago"],
  ["Gru cenerina","Grus grus","Uccelli","üïäÔ∏è","zone umide boreali","onnivoro"],
  ["Puffin","Fratercula arctica","Uccelli","üïäÔ∏è","Atlantico nordico","piscivoro"],
  ["Sterna comune","Sterna hirundo","Uccelli","üïäÔ∏è","coste e lagune","piscivoro"],
  ["Quetzal splendente","Pharomachrus mocinno","Uccelli","üïäÔ∏è","foreste neotropicali","frugivoro"],
  ["Ara macao","Ara macao","Uccelli","ü¶ú","foreste amazzoniche","frugivoro"],
  ["Kiwi","Apteryx spp.","Uccelli","ü•ù","Nuova Zelanda","insettivoro"],
  ["Em√π","Dromaius novaehollandiae","Uccelli","ü¶§","Australia arida","onnivoro"],
  ["Casuario","Casuarius casuarius","Uccelli","ü¶É","foreste della Nuova Guinea","frugivoro"],
  // Rettili
  ["Tartaruga verde","Chelonia mydas","Rettili","üê¢","tropici marini","erbivoro (alghe)"],
  ["Tartaruga liuto","Dermochelys coriacea","Rettili","üê¢","oceani","gelatofaga"],
  ["Geco leopardino","Eublepharis macularius","Rettili","ü¶é","steppe aride asiatiche","insettivoro"],
  ["Anaconda verde","Eunectes murinus","Rettili","üêç","paludi amazzoniche","carnivoro"],
  ["Basilisco comune","Basiliscus basiliscus","Rettili","ü¶é","tropici americani","onnivoro"],
  ["Varano di Timor","Varanus timorensis","Rettili","ü¶é","Indonesia","insettivoro"],
  // Anfibi
  ["Raganella mediterranea","Hyla meridionalis","Anfibi","üê∏","macchia e stagni","insettivora"],
  ["Ululone appenninico","Bombina pachypus","Anfibi","üê∏","ruscelli appenninici","insettivoro"],
  ["Sirena maggiore","Siren lacertina","Anfibi","üßú‚Äç‚ôÇÔ∏è","paludi sud-est USA","carnivoro"],
  ["Cecilia indiana","Ichthyophis spp.","Anfibi","ü™±","suoli tropicali","insettivoro"],
  // Pesci
  ["Pesce chirurgo blu","Paracanthurus hepatus","Pesci","üîµ","barriere coralline","onnivoro"],
  ["Cavalluccio marino","Hippocampus kuda","Pesci","üê¥","praterie di fanerogame","carnivoro (zooplancton)"],
  ["Squalo martello","Sphyrna lewini","Pesci","üî®","tropici oceanici","carnivoro"],
  ["Carpa comune","Cyprinus carpio","Pesci","üêü","laghi e fiumi","onnivoro"],
  ["Luccio","Esox lucius","Pesci","üé£","acque dolci temperate","carnivoro"],
  ["Trota fario","Salmo trutta fario","Pesci","üêü","torrenti alpini","carnivoro"],
  ["Pesce palla","Takifugu rubripes","Pesci","üéà","mari temperati","onnivoro"],
  ["Razza chiodata","Raja clavata","Pesci","üõ∏","fondi sabbiosi","carnivoro"],
  // Invertebrati
  ["Granchio violinista","Uca spp.","Invertebrati","ü¶Ä","mangrovie","detritivoro"],
  ["Gambero pistolero","Alpheus spp.","Invertebrati","ü¶ê","barriere coralline","carnivoro"],
  ["Corallo cervello","Diploria spp.","Invertebrati","üß†","barriere","simbionte (zooxantelle)"],
  ["Anemone di mare","Actiniaria","Invertebrati","üå∏","barriere/coste","carnivoro"],
  ["Medusa luna","Aurelia aurita","Invertebrati","üåô","mari temperati","plancton"],
  ["Ragno lupo","Lycosidae","Invertebrati","üï∑Ô∏è","prati e suoli","predatore"],
  ["Scorpione comune","Euscorpius italicus","Invertebrati","ü¶Ç","muri a secco/selve","predatore"],
  ["Chiocciola di terra","Helix pomatia","Invertebrati","üêå","boschi e orti","erbivoro"],
  ["Cariddi (paguro bernardo)","Pagurus bernhardus","Invertebrati","ü¶û","coste atlantiche","onnivoro"],
  ["Farfalla monarca","Danaus plexippus","Invertebrati","ü¶ã","Americhe","nettare (adulto)"],
  ["Baco da seta","Bombyx mori","Invertebrati","üßµ","allevamenti","foglie di gelso"]
];

/* ===== PREMIUM V3 (gi√† presenti) + NUOVE 10 PREMIUM V4 ===== */
/* Tenendo i testi lunghi concisi ma discorsivi */
const PREMIUM_V3 = [
  // (da versioni precedenti: tigre, leone, ghepardo, elefante savana, giraffa, panda gigante,
  // orso polare, lupo grigio, delfino tursiope, orca, squalo bianco, panda rosso,
  // mantide (base premium), polpo, aquila di mare coda bianca, pinguino imperatore ecc.)
  // Per brevit√† qui ripetiamo alcuni chiave; il merge gestisce i duplicati.
  {name:"Tigre",scientificName:"Panthera tigris",class:"Mammiferi",emoji:"üêØ",habitat:"Foreste e paludi dell‚ÄôAsia",diet:"Carnivoro (cervidi, cinghiali, grandi prede)",lifespan:"10‚Äì15 anni",size:"100‚Äì260 kg",conservation:"Endangered",
   description:"Muscoli sotto strisce uniche: le ‚Äòrighe‚Äô spezzano il profilo nella penombra. Cammina come un‚Äôombra su cuscinetti morbidi. Sprinter di pochi secondi, stratega per ore.",
   sociality:"Solitaria ma non asociale: territori che si sovrappongono, messaggi con graffi e marcature. Madri-tutrici insegnano ai cuccioli a ‚Äòleggere‚Äô il bosco.",
   feeding:"Preferisce ungulati; attacco laterale al collo. Dopo un grande pasto, lunghi digiuni. Ama nuotare.",
   reproduction:"Gestazione ~100 gg; 2‚Äì4 cuccioli per 18‚Äì24 mesi con la madre.",
   interactions:"Regola gli ungulati; leopardi e dholes la evitano.",
   human:"Corridoi forestali, recinti elettrificati mirati e gestione delle prede riducono i conflitti.",
   facts:["Striature uniche","Nuotatrice abile","Specie bandiera"]},
  {name:"Leone",scientificName:"Panthera leo",class:"Mammiferi",emoji:"ü¶Å",habitat:"Savana africana",diet:"Carnivoro (zebre, gnu, bufali)",lifespan:"10‚Äì14 anni",size:"‚ôÄ 120‚Äì180 kg; ‚ôÇ 150‚Äì250 kg",conservation:"Vulnerable",
   description:"Felino sociale: cooperative familiari. Criniera = protezione e segnale. Ruggito udibile a km.",
   sociality:"Femmine imparentate stabili; maschi in coalizioni. Allattamento condiviso dei cuccioli.",
   feeding:"Aguati coordinati; maschi difendono le carcasse da iene e avvoltoi.",
   reproduction:"Nascite talvolta sincronizzate.",
   interactions:"Competizione serrata con le iene maculate.",
   human:"Recinti notturni per bestiame, cani da guardiania e indennizzi rapidi.",
   facts:["Caccia cooperativa","Criniera protettiva","Ruggito-segnale"]},
  {name:"Ghepardo",scientificName:"Acinonyx jubatus",class:"Mammiferi",emoji:"üêÜ",habitat:"Savana e praterie",diet:"Carnivoro (gazzelle)",lifespan:"10‚Äì12 anni",size:"35‚Äì65 kg",conservation:"Vulnerable",
   description:"Colonna elastica, coda-timone e unghie semi-retrattili. Lo sprint √® scienza della curva.",
   sociality:"Maschi in piccoli ‚Äòcoalitions‚Äô; femmine solitarie con cuccioli.",
   feeding:"Avvicinamento basso ‚Üí accelerazione improvvisa; rinuncia se surriscalda.",
   reproduction:"2‚Äì4 cuccioli; alta predazione da leoni e iene.",
   interactions:"Predatore diurno, conflitti ridotti coi leoni.",
   human:"Corridoi faunistici e anti-bracconaggio.",
   facts:["0‚Äì100 in pochi s","Coda-timone","Caccia diurna"]},
  {name:"Aquila di mare coda bianca",scientificName:"Haliaeetus albicilla",class:"Uccelli",emoji:"ü¶Ö",habitat:"Laghi e coste nordiche",diet:"Pesci, uccelli acquatici, carcasse",lifespan:"20‚Äì30 anni",size:"Apertura fino a 2,4 m",conservation:"In aumento",
   description:"Massiccia e maestosa, becco imponente. Veleggia bassa sull‚Äôacqua sfruttando correnti.",
   sociality:"Coppie territoriali con nidi riutilizzati per anni.",
   feeding:"Presa ‚Äòa gancio‚Äô con artigli; non disdegna carogne.",
   reproduction:"1‚Äì3 uova; giovani dipendenti a lungo.",
   interactions:"Spazzina di pregio; competizione con corvidi su carcasse.",
   human:"Reintroduzioni e tutele legali ne hanno favorito il ritorno.",
   facts:["Apertura alare enorme","Nidi pluriennali","Spazzina efficiente"]}
];

/* NUOVE PREMIUM V4 (10 specie) */
const PREMIUM_V4 = [
  {name:"Gatto domestico",scientificName:"Felis catus",class:"Mammiferi",emoji:"üê±",
   habitat:"Ambienti urbani e rurali (prossimit√† umana)",diet:"Carnivoro opportunista (roditori, uccelletti, mangimi)",
   lifespan:"12‚Äì18 anni (medio)",size:"3‚Äì5 kg",conservation:"‚Äî",
   description:"Predatore leggero con sensi fini (udito e vista crepuscolare). Cammina ‚Äòin punta di cuscinetti‚Äô, vibrisse come radar di prossimit√†. Ha portato la strategia del piccolo felino nei salotti.",
   sociality:"Semi-solitario con tolleranza variabile; gruppi flessibili dove il cibo √® concentrato. Comunicazione con posture, fusa, marcature.",
   feeding:"Caccia in agguato su micro-prede. In casa mantiene sequenze di gioco che imitano l‚Äôinseguimento.",
   reproduction:"Femmine poliestre; cucciolate multiple l‚Äôanno dove non sterilizzato. Cure materne intense.",
   interactions:"Controlla roditori; pu√≤ impattare avifauna se libero all‚Äôesterno.",
   human:"Sterilizzazione, campanellini/colletti e finestre protette conciliano benessere e tutela della fauna.",
   facts:["Vista crepuscolare","Vibrisse ‚Äòradar‚Äô","Predatore opportunista"]},

  {name:"Gallina domestica",scientificName:"Gallus gallus domesticus",class:"Uccelli",emoji:"üêî",
   habitat:"Aie, piccoli allevamenti, ambienti rurali",diet:"Granivoro/onnivoro (semi, insetti, scarti)",
   lifespan:"5‚Äì10 anni",size:"2‚Äì4 kg (razza-dip.)",conservation:"‚Äî",
   description:"Discendente del gallo bankiva. Becco esploratore e zampe ‚Äòruspatrici‚Äô. Cognizione sociale sottovalutata: riconosce individui e mantiene gerarchie.",
   sociality:"Gruppi con ordine di beccata (‚Äòpecking order‚Äô). Comunicazioni vocali ricche.",
   feeding:"Raspa e seleziona semi/insetti; se libera in cortile riduce molti parassiti.",
   reproduction:"Deposizione seriale; cova di 21 giorni; pulcini precoci e seguaci.",
   interactions:"Riciclatrice naturale di scarti, ma va gestita per non disturbare la fauna selvatica.",
   human:"Benessere animale: spazio, ripari, substrati per bagni di sabbia.",
   facts:["Pecking order","Riconoscimento individuale","Riciclatrice di cortile"]},

  {name:"Corvo comune",scientificName:"Corvus corone",class:"Uccelli",emoji:"üê¶",
   habitat:"Campagne, citt√†, coste",diet:"Onnivoro (semi, insetti, carogne, rifiuti)",
   lifespan:"8‚Äì15 anni",size:"45‚Äì50 cm",conservation:"LC",
   description:"Cervello grande per la taglia: strumenti, memoria spaziale, gioco. Vocalizzazioni adattate al rumore urbano.",
   sociality:"Coppie stabili e dormitori comuni; apprendimenti culturali (apertura di noci su strade).",
   feeding:"Opportunista raffinato; scarta con il becco, nasconde avanzi.",
   reproduction:"Nido in alto; 3‚Äì6 uova; genitori attenti e lunghi periodi di apprendimento.",
   interactions:"Spazzino e controllore di insetti; pu√≤ predare nidi a terra.",
   human:"Convivenza gestibile con rifiuti chiusi e deterrenti non cruenti.",
   facts:["Uso di strumenti","Memoria di luoghi","Apprendimento sociale"]},

  {name:"Pinguino di Humboldt",scientificName:"Spheniscus humboldti",class:"Uccelli",emoji:"üêß",
   habitat:"Coste pacifiche del Per√π/Cile (corrente di Humboldt)",diet:"Pesci e cefalopodi",
   lifespan:"15‚Äì20 anni",size:"4‚Äì5 kg",conservation:"Vulnerable",
   description:"Specialista della corrente fredda: nidifica in grotte/guano, sfrutta upwelling ricchi.",
   sociality:"Coloniale; coppie fedeli ai siti; vocalizzazioni ‚Äòasinine‚Äô per riconoscersi.",
   feeding:"Immersioni rapide e coordinate vicino riva.",
   reproduction:"2 uova; cure biparentali; giovani apprendono le zone di pesca costiera.",
   interactions:"Collega reti pelagiche e coste rocciose.",
   human:"Pesca, El Ni√±o e disturbo delle colonie sono i rischi principali.",
   facts:["Corrente fredda","Nidi nel guano","Coppie fedeli"]},

  {name:"Aquila di mare coda bianca",scientificName:"Haliaeetus albicilla",class:"Uccelli",emoji:"ü¶Ö",
   habitat:"Laghi, fiumi e coste del Nord Europa/Asia",diet:"Pesci, uccelli acquatici, carogne",
   lifespan:"20‚Äì30 anni",size:"Fino a 2,4 m di apertura",conservation:"LC (in crescita)",
   description:"Rapace massiccio e poco timido. Sfrutta correnti sulla costa come ‚Äònastri trasportatori‚Äô.",
   sociality:"Coppie stabili su territori estesi; nidi ampliati per anni.",
   feeding:"‚ÄòFishing-snatch‚Äô: artigli a uncino, recupero in volo radente.",
   reproduction:"1‚Äì3 uova; giovani a lungo dipendenti per l‚Äôapprendistato di pesca.",
   interactions:"Spazzina top su carcasse; competizione con corvi e gabbiani.",
   human:"Protezioni legali e reintroduzioni hanno invertito il trend.",
   facts:["Nidi longevi","Presa a uncino","Ritorno in Europa"]},

  {name:"Canguro rosso",scientificName:"Osphranter rufus",class:"Mammiferi",emoji:"ü¶ò",
   habitat:"Zone aride/semiaride australiane",diet:"Erbivoro (erbe e frasche)",
   lifespan:"12‚Äì18 anni",size:"Maschi 55‚Äì90 kg",conservation:"LC",
   description:"Saltatore economico: il tendine d‚ÄôAchille immagazzina energia elastica. Coda come terza gamba per sterzare e appoggiarsi.",
   sociality:"Gruppi fluidi; maschi ‚Äòboxing‚Äô rituale.",
   feeding:"Pasto notturno e crepuscolare; risparmia acqua e calore.",
   reproduction:"Diapausa embrionale: pausa dello sviluppo se le condizioni sono dure.",
   interactions:"Modella il pascolo e funge da preda per dingo/rapaci.",
   human:"Gestione dei pascoli e passaggi faunistici riducono impatti stradali.",
   facts:["Salto elastico","Coda-terza gamba","Diapausa embrionale"]},

  {name:"Capibara",scientificName:"Hydrochoerus hydrochaeris",class:"Mammiferi",emoji:"ü´é",
   habitat:"Zone umide sudamericane",diet:"Erbivoro (erbe acquatiche)",
   lifespan:"7‚Äì10 anni",size:"35‚Äì65 kg",conservation:"LC",
   description:"Il roditore pi√π grande: piedi palmati, vita in acqua/terra. Socialit√† pacifica con ‚Äòchiacchiere‚Äô sonore.",
   sociality:"Gruppi con gerarchie miti e babysitting condiviso.",
   feeding:"Bruca vicino all‚Äôacqua; digerisce fibre con fermentazione intestinale.",
   reproduction:"Piccoli precoci che nuotano presto; allattamento in gruppo.",
   interactions:"Taglia l‚Äôerba acquatica, crea ‚Äòprati‚Äô per altri.",
   human:"Conflitti locali con colture; zone cuscinetto riducono i danni.",
   facts:["Piede palmato","Babysitting","Fermentazione intestinale"]},

  {name:"Drago di Komodo",scientificName:"Varanus komodoensis",class:"Rettili",emoji:"ü¶é",
   habitat:"Isole indonesiane aride",diet:"Carnivoro (ungulati, carogne)",
   lifespan:"20‚Äì30 anni",size:"Fino a 3 m",conservation:"Endangered (locale)",
   description:"Varano gigante con olfatto ‚Äòa lingua bifida‚Äô. Preda d‚Äôagguato, morso potente, coadiuvato da batteri e tossine salivari.",
   sociality:"Solista; aggregazioni sulle carcasse con gerarchie.",
   feeding:"Scatti brevi; inghiotte grandi porzioni grazie a mandibole flessibili.",
   reproduction:"Oviparo; femmine talvolta partenogenetiche in cattivit√†.",
   interactions:"Scavenger e predatore apicale di piccole isole.",
   human:"Turismo regolato e tutela degli ungulati nativi sono cruciali.",
   facts:["Lingua ‚Äòolfatto‚Äô","Tossine salivari","Partenogenesi osservata"]},

  {name:"Mantide religiosa",scientificName:"Mantis religiosa",class:"Invertebrati",emoji:"ü¶ó",
   habitat:"Prati e margini coltivi",diet:"Predatrice di insetti",
   lifespan:"1 anno",size:"5‚Äì7 cm (‚ôÄ)",conservation:"‚Äî",
   description:"Statua verde che si trasforma in trappola. Zampe raptatorie spinose, collo mobile e visione stereoscopica.",
   sociality:"Solitario; incontri quasi solo per accoppiamento.",
   feeding:"Aspetta immobile e fulmina prede con un lampo delle zampe.",
   reproduction:"Ooteca spumosa che indurisce e protegge decine di ninfe.",
   interactions:"Controllo naturale dei fitofagi; pu√≤ prendere impollinatori se abbondante.",
   human:"Alleata dell‚Äôorto se si evitano insetticidi generici.",
   facts:["Zampe-lama","Testa mobile","Ooteca protettiva"]},

  {name:"Pesce pagliaccio",scientificName:"Amphiprion ocellaris",class:"Pesci",emoji:"üê†",
   habitat:"Barriere coralline (anemoni simbionti)",diet:"Onnivoro (alghe, zooplancton, piccoli invertebrati)",
   lifespan:"6‚Äì10 anni",size:"8‚Äì11 cm",conservation:"LC",
   description:"Colori vivaci e vita tra i tentacoli urticanti dell‚Äôanemone, resi innocui da un muco protettivo.",
   sociality:"Gruppi con femmina dominante; maschi subordinati.",
   feeding:"Pizzica cibo vicino all‚Äôanemone e pulisce i resti.",
   reproduction:"Uova deposte su roccia vicino all‚Äôanemone; maschio ventila e cura.",
   interactions:"Simbiosi: protegge l‚Äôanemone da piccoli predatori e ne pulisce la superficie.",
   human:"Raccolta eccessiva pu√≤ impattare; allevamenti responsabili riducono pressione.",
   facts:["Simbiosi con anemone","Gerarchia femmina-alfa","Muco protettivo"]}
];

/* ===== COMBINAZIONE DATI ===== */
let ANIMALS = [...BASE_BULK, ...MORE_BULK].map(expandLite);
/* ID & haystack */
ANIMALS.forEach(a=>{ a.id = slug(a.name); a._hay = [a.name,a.scientificName,a.habitat,a.diet,a.class,(a.facts||[]).join(" ")].join(" ").toLowerCase(); });
/* Merge premium (v3 + v4) per nome (sovrascrive se gi√† esiste) */
const PREMIUM = [...PREMIUM_V3, ...PREMIUM_V4];
const idx = new Map(ANIMALS.map((a,i)=>[a.name,i]));
PREMIUM.forEach(p=>{
  p.id = slug(p.name);
  p._hay = [p.name,p.scientificName,p.habitat,p.diet,p.class,(p.facts||[]).join(" ")].join(" ").toLowerCase();
  if(idx.has(p.name)) ANIMALS[idx.get(p.name)]=p; else ANIMALS.push(p);
});

/* ===== UI ===== */
function cardTpl(a){
  const hc = habClass(a.habitat||"");
  return `<article class="card" aria-label="${a.name}">
    <div class="thumb ${hc}"><div class="emoji">${a.emoji||'üß¨'}</div></div>
    <div class="body">
      <span class="badge">${a.class||'‚Äî'}</span>
      <h3>${a.name}</h3>
      <div class="meta"><i>${a.scientificName||'‚Äî'}</i></div>
      <div class="actions"><a class="btn" href="#/animal/${a.id}">Apri scheda</a></div>
    </div>
  </article>`;
}
function listTpl(){
  const items = filteredItems();
  const cards = items.map(cardTpl).join('');
  return `<div class="grid">${cards || emptyTpl()}</div>`;
}
function quickFacts(a){
  return `<div class="panel pad quick">
    <h3 style="margin-top:0">Scheda rapida</h3>
    <div class="kv">
      <div class="meta">Nome scientifico</div><div><i>${a.scientificName||'‚Äî'}</i></div>
      <div class="meta">Classe</div><div>${a.class||'‚Äî'}</div>
      <div class="meta">Habitat</div><div>${a.habitat||'‚Äî'}</div>
      <div class="meta">Dieta</div><div>${a.diet||'‚Äî'}</div>
      <div class="meta">Vita media</div><div>${a.lifespan||'‚Äî'}</div>
      <div class="meta">Dimensioni</div><div>${a.size||'‚Äî'}</div>
      <div class="meta">Conservazione</div><div>${a.conservation||'‚Äî'}</div>
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:12px">
      ${(a.facts||[]).slice(0,6).map(f=>`<span class="chip">${f}</span>`).join('')}
    </div>
  </div>`;
}
function acc(id,t,html){ return `<details class="acc" id="${id}"><summary class="acc-sum"><span class="chev">‚ñ∂</span> ${t}</summary><div class="acc-body">${html}</div></details>`; }
function detailTpl(a){
  const hc = habClass(a.habitat||"");
  const facts = (a.facts||[]).map(f=>`<li>${f}</li>`).join('');
  const finale = (a.facts && a.facts[0]) ? a.facts[0] : "Questo animale riserva sempre sorprese.";
  return `<div class="detail">
    <div>
      <div class="hero-animal panel">
        <div class="banner ${hc}"><div class="emoji">${a.emoji||'üß¨'}</div></div>
        <div class="head">
          <div style="flex:1;min-width:240px">
            <h2>${a.name}</h2>
            <div class="meta"><i>${a.scientificName||''}</i></div>
            <div class="toc" aria-label="vai a sezione">
              <a href="#" data-target="#desc">Descrizione</a>
              <a href="#" data-target="#soc">Socialit√†</a>
              <a href="#" data-target="#feed">Alimentazione</a>
              <a href="#" data-target="#repr">Riproduzione</a>
              <a href="#" data-target="#eco">Ruolo ecologico</a>
              <a href="#" data-target="#hum">Rapporto con l'uomo</a>
              <a href="#" data-target="#facts">Curiosit√†</a>
            </div>
          </div>
          <div><a class="btn" href="#/home">‚Üê Torna all'elenco</a></div>
        </div>
      </div>

      <div id="desc" class="panel pad section"><h3>Descrizione generale</h3><p>${a.description||'‚Äî'}</p></div>
      ${acc('soc','Socialit√† e comportamento', `<p>${a.sociality||'‚Äî'}</p>`)}
      ${acc('feed','Alimentazione e caccia', `<p>${a.feeding||'‚Äî'}</p>`)}
      ${acc('repr','Riproduzione e crescita', `<p>${a.reproduction||'‚Äî'}</p>`)}
      ${acc('eco','Ruolo ecologico e predatori', `<p>${a.interactions||'‚Äî'}</p>`)}
      ${facts? acc('facts','Curiosit√†', `<ul>${facts}</ul>`) : ''}
      ${acc('hum',"Rapporto con l'uomo", `<p>${a.human||'‚Äî'}</p>`)}
      <div class="panel pad callout" style="margin-top:12px"><b>Lo sapevi che‚Ä¶</b> ${finale}</div>
    </div>
    ${quickFacts(a)}
  </div>`;
}
function curiositaTpl(){
  const pick = arr=>arr[Math.floor(Math.random()*arr.length)];
  const facts = [];
  for(let i=0;i<6;i++){ const a = pick(ANIMALS); facts.push(`<li><b>${a.name}:</b> ${pick(a.facts||[a.description||'‚Äî'])}</li>`); }
  return `<div class="panel pad"><h2 style="margin-top:0">Curiosit√† casuali ‚ú®</h2><ul>${facts.join('')}</ul></div>`;
}
function contattiTpl(){ return `<div class="panel pad"><h2 style="margin-top:0">Contatti</h2><p>Progetto didattico. Apri una issue sul repository per proposte e correzioni.</p></div>` }
function emptyTpl(){ return `<div class="panel pad"><p>Nessun risultato. Prova a cambiare ricerca o filtro.</p></div>` }

/* ===== RENDER & ROUTER ===== */
function filteredItems(){
  const q = (state.q||'').trim().toLowerCase();
  return ANIMALS
    .filter(a => (!q || a._hay.includes(q)))
    .filter(a => (!state.cls || a.class===state.cls))
    .sort(by('name'));
}
function applyRandomTheme(){ const t = THEMES[Math.floor(Math.random()*THEMES.length)]; applyTheme(t); }
function render(){
  const container = qs('#view');
  const hash = location.hash.replace('#','') || '/home';
  state.route = hash;
  if(hash.startsWith('/animal/')){
    const id = hash.split('/')[2];
    const a = ANIMALS.find(x=>x.id===id);
    if(a) applyTheme(toTheme(habClass(a.habitat||"")));
    container.innerHTML = a ? detailTpl(a) : `<div class="panel pad"><h2>Ops!</h2><p>Animale non trovato.</p></div>`;
    if(a) bindTocLinks();
    return;
  }
  if(hash==='/curiosita'){ applyRandomTheme(); container.innerHTML = curiositaTpl(); return; }
  if(hash==='/contatti'){ applyTheme('theme-prateria'); container.innerHTML = contattiTpl(); return; }
  if(hash==='/animali' || hash==='/home'){ applyRandomTheme(); container.innerHTML = listTpl(); return; }
  applyRandomTheme(); container.innerHTML = listTpl();
}

/* ===== INTERAZIONE ===== */
function goRandom(){ const items = filteredItems(); if(!items.length) return; const pick = items[Math.floor(Math.random()*items.length)]; location.hash = `#/animal/${pick.id}`; showToast(`Hai pescato: ${pick.name}! üé≤`); }
function openAllSections(){ document.querySelectorAll('#view details.acc').forEach(d=> d.open = true); }
function closeAllSections(){ document.querySelectorAll('#view details.acc').forEach(d=> d.open = false); }
function bindTocLinks(){ document.querySelectorAll('.toc a[data-target]').forEach(a=>{ a.addEventListener('click', (e)=>{ e.preventDefault(); const el = document.querySelector(a.getAttribute('data-target')); if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); } }); }); }
function setupControls(){
  document.querySelector('#q').addEventListener('input', e=>{ state.q = e.target.value; render(); });
  document.querySelector('#filterClass').addEventListener('change', e=>{ state.cls = e.target.value; render(); });
  const br = document.querySelector('#btnRandom'); if(br) br.addEventListener('click', goRandom);
  window.addEventListener('keydown', (e)=>{
    if(e.key && e.key.toLowerCase()==='r' && !e.metaKey && !e.ctrlKey && !e.altKey){
      const a = document.activeElement; if(a && (a.tagName==='INPUT' || a.tagName==='TEXTAREA' || a.isContentEditable)) return;
      e.preventDefault(); goRandom();
    }
  });
}
window.addEventListener('hashchange', render);
window.addEventListener('DOMContentLoaded', ()=>{ setupControls(); render(); });
window.addEventListener('error', ()=>{ showToast('‚ö†Ô∏è Errore script: controlla che il copia/incolla sia completo'); });
</script>
</body>
</html>
