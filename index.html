<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Biolo-Gio | Enciclopedia (v7.5 fit intelligente anche in Home)</title>
<meta name="description" content="Enciclopedia degli animali con immagini automatiche da Wikipedia/Wikimedia, habitat tematici e adattamento foto sia nelle card sia nel banner." />
<style>
  :root{ --panel:#fff; --muted:#475569; --text:#0f172a; --ring:#22d3ee55; --radius:18px; --t0:#ffffff; --t1:#f1f5f9; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; color:var(--text); background:#f1f5f9; line-height:1.6;}

  header{position:sticky; top:0; z-index:50; backdrop-filter:saturate(120%) blur(10px); background:linear-gradient(180deg,#ffffffee,#ffffffcc); border-bottom:1px solid #e2e8f0}
  .wrap{max-width:1180px; margin:auto; padding:16px}
  .topbar{display:flex; align-items:center; gap:16px}
  .logo{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
  .logo .mark{width:38px;height:38px;border-radius:12px;display:grid;place-items:center; background:conic-gradient(from 210deg,#06b6d4,#8b5cf6 40%,#10b981); box-shadow:0 0 0 4px #00000005 inset, 0 10px 30px #0001;}
  .logo b{font-size:20px}
  nav{margin-left:auto; display:flex; gap:14px; flex-wrap:wrap}
  nav a{color:var(--muted); text-decoration:none; padding:8px 12px; border-radius:10px}
  nav a:hover{color:var(--text); background:#e2e8f0}

  .hero{display:grid; gap:4px; padding:24px 0 8px}
  .hero h1{margin:0; font-size:clamp(28px,4vw,44px)}
  .hero p{margin:0; color:var(--muted)}

  .panel{background:var(--panel); border:1px solid #e2e8f0; border-radius:var(--radius); box-shadow:0 8px 30px #0000000d}
  .panel.pad{padding:16px}

  .controls{display:grid; grid-template-columns:1fr 220px 220px; gap:12px; align-items:center}
  .search{position:relative}
  .search input{width:100%; padding:14px 44px 14px 14px; border-radius:12px; border:1px solid #cbd5e1; background:#fff; color:#0f172a}
  .search input:focus{outline:none; box-shadow:0 0 0 6px var(--ring)}
  .search .icon{position:absolute; right:12px; top:50%; transform:translateY(-50%); opacity:.6}
  select{width:100%; padding:14px; border-radius:12px; border:1px solid #cbd5e1; background:#fff; color:#0f172a}
  .toggle{display:flex; align-items:center; gap:10px; border:1px solid #cbd5e1; padding:10px 12px; border-radius:12px; background:#fff}
  .toggle input{accent-color:#06b6d4}

  .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(240px,1fr)); gap:16px; margin-top:16px}
  .card{background:#fff; border:1px solid #e2e8f0; border-radius:16px; overflow:hidden; transition:transform .15s, box-shadow .15s}
  .card:hover{transform:translateY(-4px); box-shadow:0 12px 30px #00000014}

  /* THUMB: adesso con livello blur per riempire quando la foto √® ‚Äúcontain‚Äù */
  .thumb{height:160px; position:relative; overflow:hidden; display:grid; place-items:center}
  .thumb img{position:relative; width:100%; height:100%; object-fit:cover; display:block; transition:transform .4s ease; filter:saturate(1.05) contrast(1.02); object-position:center}
  .thumb .bg-blur{position:absolute; inset:0; background-size:cover; background-position:center; filter:blur(18px) saturate(1.1) brightness(.9); transform:scale(1.1); opacity:0; transition:opacity .25s; pointer-events:none}
  .thumb .emoji{position:absolute; font-size:72px; filter:drop-shadow(0 2px 6px rgba(0,0,0,.12))}
  .card:hover .thumb img{transform:scale(1.03)}
  .thumb::after{content:""; position:absolute; inset:0; background-image:
    repeating-linear-gradient(45deg, rgba(255,255,255,.25) 0 8px, transparent 8px 16px),
    repeating-radial-gradient( circle at 20% 30%, rgba(0,0,0,.05) 0 1.8px, transparent 1.8px 10px);
    background-size:200px 200px, 160px 160px; mix-blend-mode:soft-light; pointer-events:none;}

  /* banner habitat */
  .hab-foresta{background-image:linear-gradient(135deg,#dcfce7,#bbf7d0)}
  .hab-savana{background-image:linear-gradient(135deg,#fef9c3,#fde68a)}
  .hab-oceano{background-image:linear-gradient(135deg,#e0f2fe,#bae6fd)}
  .hab-montagna{background-image:linear-gradient(135deg,#e2e8f0,#cbd5e1)}
  .hab-ghiaccio{background-image:linear-gradient(135deg,#f1f5f9,#e0f2fe)}
  .hab-deserto{background-image:linear-gradient(135deg,#ffedd5,#fed7aa)}
  .hab-prateria{background-image:linear-gradient(135deg,#d1fae5,#a7f3d0)}

  .badge{display:inline-block; padding:4px 8px; border:1px solid #c7d2fe; border-radius:999px; font-size:12px; color:#4338ca; background:#eef2ff}
  .card .body{padding:12px 14px}
  .card h3{margin:0 0 6px; font-size:18px}
  .meta{font-size:13px; color:#475569}
  .btn{appearance:none; border:none; padding:10px 12px; border-radius:10px; background:#dbf4ff; color:#0c4a6e; cursor:pointer; text-decoration:none; display:inline-flex; gap:8px; align-items:center}
  .btn:hover{background:#bae6fd}

  /* DETTAGLIO: banner smart (come v7.4) */
  .detail{margin-top:24px; display:grid; grid-template-columns:1.6fr 0.9fr; gap:18px}
  .hero-animal{border-radius:16px; overflow:hidden; position:relative; border:1px solid #e2e8f0}
  .hero-animal .banner{height:clamp(220px, 28vw, 340px); display:grid; place-items:center; font-size:0; position:relative; cursor:zoom-in}
  .hero-animal .banner img.photo{position:absolute; inset:0; width:100%; height:100%; display:block; filter:saturate(1.05) contrast(1.03); object-position:center}
  .fit-cover{object-fit:cover;}
  .fit-contain{object-fit:contain; background:#f8fafc;}
  .hero-animal .banner .overlay{position:absolute; inset:0; mix-blend-mode:multiply; opacity:.85; pointer-events:none}
  .hero-animal .head{position:relative; display:flex; gap:16px; align-items:center; padding:12px 16px}
  .quick{position:sticky; top:90px; align-self:start}
  .quick .kv{display:grid; grid-template-columns:auto 1fr; gap:8px 12px; font-size:14px}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#f1f5f9; border:1px solid #e2e8f0; font-size:12px}

  .toc{display:flex; flex-wrap:wrap; gap:8px; padding:8px 0}
  .toc a{padding:6px 10px; border:1px solid #e2e8f0; border-radius:999px; text-decoration:none; color:#334155; background:#fff}
  .toc a:hover{background:#f8fafc}

  details.acc{border:1px solid #e2e8f0; border-radius:12px; background:#fff; margin:14px 0; overflow:hidden}
  details.acc[open]{box-shadow:0 8px 24px #0000000d}
  summary.acc-sum{list-style:none; cursor:pointer; padding:12px 14px; display:flex; align-items:center; gap:10px; font-weight:600}
  summary.acc-sum .chev{transition:transform .2s; opacity:.7}
  details[open] summary.acc-sum .chev{transform:rotate(90deg)}
  .acc-body{padding:0 14px 14px}
  .callout{background:#ecfeff; border:1px solid #bae6fd; padding:10px 12px; border-radius:12px; font-size:14px}
  .src{font-size:12px; color:#334155; margin-top:6px}
  .src a{color:#0369a1; text-decoration:none}
  .src a:hover{text-decoration:underline}

  .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(40px);background:linear-gradient(135deg,#06b6d4,#8b5cf6);color:#fff;padding:10px 18px;border-radius:12px;box-shadow:0 8px 30px #00000026;opacity:0;pointer-events:none;transition:opacity .35s, transform .35s;z-index:9999}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* Pattern di sfondo globale */
  @keyframes drift {0%{background-position:0 0,0 0,0 0,200px 200px}100%{background-position:0 0,0 0,0 0,400px 400px}}
  body[class*="theme-"]{
    background-attachment:fixed;
    background-image:
      linear-gradient(180deg, var(--t0), var(--t1) 60%),
      radial-gradient(900px 700px at 110% 0%, rgba(255,255,255,.45), transparent),
      repeating-radial-gradient(circle at 25% 25%, rgba(0,0,0,.06) 0 2px, transparent 2px 12px),
      repeating-linear-gradient(135deg, rgba(0,0,0,.05) 0 10px, transparent 10px 22px);
    background-size:auto,auto,140px 140px,160px 160px!important;
    background-blend-mode:normal,normal,overlay,overlay; animation:drift 120s linear infinite;
  }
</style>
</head>
<body>
<header>
  <div class="wrap topbar">
    <a class="logo" href="#/home"><div class="mark">üß¨</div><b>Biolo-Gio</b></a>
    <nav><a href="#/home">Home</a><a href="#/animali">Animali</a><a href="#/curiosita">Curiosit√†</a><a href="#/contatti">Contatti</a></nav>
  </div>
</header>

<main class="wrap">
  <section class="hero">
    <h1>Biolo-Gio v7.5 ‚Äî foto smart anche nella Home</h1>
    <p>Le card non tagliano pi√π le immagini verticali: passano a ‚Äúintera‚Äù con sfondo sfocato.</p>
  </section>

  <section class="panel pad" id="controls">
    <div class="controls">
      <label class="search">
        <input id="q" placeholder="Cerca per nome, habitat, dieta‚Ä¶ (es. ‚Äòfalco‚Äô, ‚Äòsavana‚Äô, ‚Äòinsettivoro‚Äô)" autocomplete="off" />
        <span class="icon">üîé</span>
      </label>
      <label>
        <select id="filterClass">
          <option value="">Tutte le classi</option>
          <option>Mammiferi</option><option>Uccelli</option><option>Rettili</option>
          <option>Anfibi</option><option>Pesci</option><option>Invertebrati</option>
        </select>
      </label>
      <label class="toggle" title="Attiva/Disattiva foto (fallback emoji)">
        <input type="checkbox" id="togglePhotos" checked />
        <span>üñºÔ∏è Foto realistiche</span>
      </label>
    </div>
    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" id="btnRandom">üé≤ Animale casuale</button>
      <span class="meta">Premi <kbd>R</kbd> per pescarne uno a caso.</span>
    </div>
  </section>

  <section id="view"></section>

  <footer class="wrap" style="margin:30px 0 60px; color:#475569">
    Immagini via <a href="https://www.wikipedia.org/" target="_blank" rel="noopener">Wikipedia/Wikimedia</a>. Attribution nel dettaglio quando disponibile.
  </footer>
</main>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ===== UTIL ===== */
const slug = s => s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
const by = key => (a,b)=> (a[key]||"").localeCompare(b[key]||"");
const qs = sel => document.querySelector(sel);
const state = { q:"", cls:"", route:"/home", photos:true };
function showToast(msg){ const t = document.querySelector('#toast'); t.textContent = msg; t.classList.add('show'); clearTimeout(showToast._t); showToast._t = setTimeout(()=> t.classList.remove('show'), 2000); }

/* ===== THEME / HABITAT ===== */
const THEMES = ['theme-foresta','theme-savana','theme-oceano','theme-montagna','theme-ghiaccio','theme-deserto','theme-prateria'];
function applyTheme(theme){
  const map = {"theme-foresta":["#f0fdf4","#dcfce7"],"theme-savana":["#fffbeb","#fef9c3"],"theme-oceano":["#f0f9ff","#e0f2fe"],"theme-montagna":["#f8fafc","#e2e8f0"],"theme-ghiaccio":["#f8fafc","#e0f2fe"],"theme-deserto":["#fff7ed","#ffedd5"],"theme-prateria":["#ecfeff","#d1fae5"]};
  document.body.classList.remove(...THEMES);
  document.body.classList.add(theme);
  const [t0,t1]=map[theme]||map["theme-prateria"];
  document.documentElement.style.setProperty('--t0', t0);
  document.documentElement.style.setProperty('--t1', t1);
}
const habClass=(hab='')=>{const h=(hab||'').toLowerCase(); if(h.includes('foresta')||h.includes('bosco'))return'hab-foresta'; if(h.includes('savana')||h.includes('prateria')||h.includes('steppe'))return'hab-savana'; if(h.includes('ghiaccio')||h.includes('antart')||h.includes('polo'))return'hab-ghiaccio'; if(h.includes('mare')||h.includes('oceano')||h.includes('coste')||h.includes('acque'))return'hab-oceano'; if(h.includes('monta')||h.includes('scoglier')||h.includes('alp'))return'hab-montagna'; if(h.includes('deserto')||h.includes('arido')||h.includes('sabbia'))return'hab-deserto'; return'hab-prateria';};
const toTheme=hc=>({'hab-foresta':'theme-foresta','hab-savana':'theme-savana','hab-ghiaccio':'theme-ghiaccio','hab-oceano':'theme-oceano','hab-montagna':'theme-montagna','hab-deserto':'theme-deserto','hab-prateria':'theme-prateria'}[hc]||'theme-prateria');

/* ===== IMMAGINI DA WIKIPEDIA ===== */
const COMMON_EN={"Leone":"Lion","Tigre":"Tiger","Ghepardo":"Cheetah","Lupo grigio":"Gray wolf","Gatto domestico":"Cat","Wombat":"Wombat","Capibara":"Capybara","Drago di Komodo":"Komodo dragon","Falco pellegrino":"Peregrine falcon","Aquila reale":"Golden eagle","Corvo comune":"Carrion crow","Pinguino di Humboldt":"Humboldt penguin","Cobra reale":"King cobra","Squalo balena":"Whale shark","Bue muschiato":"Muskox","Pangolino":"Pangolin","Alce":"Moose","Carib√π/Renna":"Reindeer","Pellicano bianco":"Great white pelican","Pappagallo cenerino":"African grey parrot","Cormorano grande":"Great cormorant","Squalo martello":"Scalloped hammerhead"};
async function wikiSummary(title, lang='it'){try{const r=await fetch(`https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`,{mode:'cors',referrerPolicy:'no-referrer'});if(!r.ok)throw new Error(r.status);return await r.json()}catch(e){return null}}
async function findWikiImage(titles){for(const t of titles){let j=await wikiSummary(t,'it');if(j && j.thumbnail && j.thumbnail.source)return{src:j.thumbnail.source,credit:j.titles?.normalized||t,lang:'it',page:j.content_urls?.desktop?.page};j=await wikiSummary(t,'en');if(j && j.thumbnail && j.thumbnail.source)return{src:j.thumbnail.source,credit:j.titles?.normalized||t,lang:'en',page:j.content_urls?.desktop?.page}}return null}
function titlesFor(a){const arr=[]; if(a.scientificName)arr.push(a.scientificName); if(a.name)arr.push(a.name); if(COMMON_EN[a.name])arr.push(COMMON_EN[a.name]); return Array.from(new Set(arr))}

/* ===== TESTI ‚ÄúLITE‚Äù ===== */
const EMOJI_BY_CLASS={"Mammiferi":"ü¶å","Uccelli":"üê¶","Rettili":"ü¶é","Anfibi":"üê∏","Pesci":"üêü","Invertebrati":"ü™≤"};
const TEMPLATES={desc:({name,habitat,cls})=>`${name} vive soprattutto in ${habitat.toLowerCase()}. √à un tipico rappresentante dei ${cls.toLowerCase()}, con adattamenti pratici all‚Äôambiente e alla dieta.`,soc:({name,cls})=>`La socialit√† di ${name} rientra nei ${cls.toLowerCase()}: pi√π territoriale in riproduzione e pi√π tollerante quando cibo e ripari abbondano.`,feed:({diet})=>`Dieta: ${diet.toLowerCase()}. L‚Äôattivit√† segue le ore migliori (alba/crepuscolo) e i microhabitat favorevoli.`,repr:({name})=>`Corteggiamenti specifici e cure parentali variabili; i giovani di ${name} apprendono presto rifugi sicuri e fonti locali di cibo.`,eco:({name})=>`${name} contribuisce all‚Äôequilibrio: controlla prede/competitori o disperde semi; a sua volta √® risorsa per predatori superiori.`,hum:({habitat})=>`Rischi: frammentazione di ${habitat.toLowerCase()}, traffico, inquinamento, disturbo. Utili corridoi ecologici e tutela dei siti riproduttivi.`};
function expandLite([name,scientificName,cls,emoji,habitat,diet]){const base={name,scientificName,class:cls,emoji:emoji||EMOJI_BY_CLASS[cls]||"üß¨",habitat,diet,lifespan:"‚Äî",size:"‚Äî",conservation:"‚Äî"};const ctx={name,habitat,cls};return{...base,description:TEMPLATES.desc(ctx),sociality:TEMPLATES.soc(ctx),feeding:TEMPLATES.feed({diet}),reproduction:TEMPLATES.repr(ctx),interactions:TEMPLATES.eco(ctx),human:TEMPLATES.hum({habitat}),facts:["Adattabile","Ruolo ecologico rilevante","Convivenza possibile"]}}

/* ===== DATASET (estratto) ===== */
const BASE_BULK=[["Leone","Panthera leo","Mammiferi","ü¶Å","savana africana","carnivoro (ungulati)"],["Tigre","Panthera tigris","Mammiferi","üêØ","foreste e paludi asiatiche","carnivoro"],["Ghepardo","Acinonyx jubatus","Mammiferi","üêÜ","savana","carnivoro (antilopi)"],["Lupo grigio","Canis lupus","Mammiferi","üê∫","foreste e tundre","carnivoro"],["Gatto domestico","Felis catus","Mammiferi","üê±","ambienti urbani e rurali","carnivoro opportunista"],["Wombat","Vombatus ursinus","Mammiferi","ü¶•","boscaglie australiane","erbivoro"],["Capibara","Hydrochoerus hydrochaeris","Mammiferi","ü´é","zone umide sudamericane","erbivoro"],["Drago di Komodo","Varanus komodoensis","Rettili","ü¶é","isole indonesiane","carnivoro"],["Falco pellegrino","Falco peregrinus","Uccelli","ü™∂","scogliere e citt√†","carnivoro"],["Aquila reale","Aquila chrysaetos","Uccelli","ü¶Ö","montagne e scogliere","carnivoro"],["Corvo comune","Corvus corone","Uccelli","üê¶","campagne e citt√†","onnivoro"],["Pinguino di Humboldt","Spheniscus humboldti","Uccelli","üêß","coste pacifiche sudamericane","piscivoro"],["Cobra reale","Ophiophagus hannah","Rettili","üêç","foreste asiatiche","ofiofago (serpenti)"],["Squalo balena","Rhincodon typus","Pesci","üõ≥Ô∏è","tropici oceanici","planctofago"],["Bue muschiato","Ovibos moschatus","Mammiferi","üêÆ","tundra artica","erbivoro"],["Pangolino","Manis spp.","Mammiferi","ü¶î","foreste/savane tropicali","mirmecofago"],["Alce","Alces alces","Mammiferi","ü´é","foreste boreali","erbivoro"],["Carib√π/Renna","Rangifer tarandus","Mammiferi","ü¶å","tundra e taiga","erbivoro"],["Pellicano bianco","Pelecanus onocrotalus","Uccelli","ü¶¢","laghi e delta","piscivoro"],["Pappagallo cenerino","Psittacus erithacus","Uccelli","ü¶ú","foreste africane","frugivoro"],["Cormorano grande","Phalacrocorax carbo","Uccelli","üñ§","laghi e coste","piscivoro"],["Squalo martello","Sphyrna lewini","Pesci","üî®","mari tropicali","carnivoro"]];

let ANIMALS=BASE_BULK.map(expandLite);
ANIMALS.forEach(a=>{a.id=slug(a.name); a._hay=[a.name,a.scientificName,a.habitat,a.diet,a.class,(a.facts||[]).join(" ")].join(" ").toLowerCase()});

/* ===== TEMPLATE UI ===== */
function cardTpl(a){
  const hc=habClass(a.habitat||"");
  const titles=titlesFor(a).map(t=>t.replace(/"/g,'&quot;')).join('|');
  const img=state.photos?`<div class="bg-blur" aria-hidden="true"></div><img class="fit-cover" referrerpolicy="no-referrer" loading="lazy" alt="${a.name}" data-wiki="${titles}" />`:'';
  return `<article class="card" aria-label="${a.name}">
    <div class="thumb ${hc}">
      ${img}
      <div class="emoji" style="display:${state.photos?'none':'grid'}">${a.emoji||'üß¨'}</div>
    </div>
    <div class="body">
      <span class="badge">${a.class||'‚Äî'}</span>
      <h3>${a.name}</h3>
      <div class="meta"><i>${a.scientificName||'‚Äî'}</i></div>
      <div class="actions"><a class="btn" href="#/animal/${a.id}">Apri scheda</a></div>
    </div>
  </article>`;
}
function listTpl(){const items=filteredItems();const cards=items.map(cardTpl).join('');return `<div class="grid">${cards||emptyTpl()}</div>`}
function quickFacts(a){return `<div class="panel pad quick"><h3 style="margin-top:0">Scheda rapida</h3><div class="kv">
<div class="meta">Nome scientifico</div><div><i>${a.scientificName||'‚Äî'}</i></div>
<div class="meta">Classe</div><div>${a.class||'‚Äî'}</div>
<div class="meta">Habitat</div><div>${a.habitat||'‚Äî'}</div>
<div class="meta">Dieta</div><div>${a.diet||'‚Äî'}</div>
<div class="meta">Vita media</div><div>${a.lifespan||'‚Äî'}</div>
<div class="meta">Dimensioni</div><div>${a.size||'‚Äî'}</div>
<div class="meta">Conservazione</div><div>${a.conservation||'‚Äî'}</div>
</div><div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:12px">${(a.facts||[]).slice(0,6).map(f=>`<span class="chip">${f}</span>`).join('')}</div></div>`}
function acc(id,t,html){return `<details class="acc" id="${id}"><summary class="acc-sum"><span class="chev">‚ñ∂</span> ${t}</summary><div class="acc-body">${html}</div></details>`}
function detailTpl(a){
  const hc=habClass(a.habitat||"");
  const facts=(a.facts||[]).map(f=>`<li>${f}</li>`).join('');
  const finale=(a.facts&&a.facts[0])?a.facts[0]:"Questo animale riserva sempre sorprese.";
  const titles=titlesFor(a).map(t=>t.replace(/"/g,'&quot;')).join('|');
  const banner=state.photos?`<img class="photo fit-cover" referrerpolicy="no-referrer" alt="${a.name}" data-wiki="${titles}" />`:'';
  return `<div class="detail">
    <div>
      <div class="hero-animal panel">
        <div class="banner ${hc}" id="bannerBox">
          ${banner}
          <div class="overlay ${hc}"></div>
        </div>
        <div class="head">
          <div style="flex:1;min-width:240px">
            <h2>${a.name}</h2>
            <div class="meta"><i>${a.scientificName||''}</i></div>
            <div class="toc" aria-label="vai a sezione">
              <a href="#" data-target="#desc">Descrizione</a>
              <a href="#" data-target="#soc">Socialit√†</a>
              <a href="#" data-target="#feed">Alimentazione</a>
              <a href="#" data-target="#repr">Riproduzione</a>
              <a href="#" data-target="#eco">Ruolo ecologico</a>
              <a href="#" data-target="#hum">Rapporto con l'uomo</a>
              <a href="#" data-target="#facts">Curiosit√†</a>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
              <button class="btn" id="fitToggle" type="button">üñºÔ∏è Adatta immagine: Cover</button>
            </div>
            <div class="src" id="img-credit"></div>
          </div>
          <div><a class="btn" href="#/home">‚Üê Torna all'elenco</a></div>
        </div>
      </div>

      <div id="desc" class="panel pad section"><h3>Descrizione generale</h3><p>${a.description||'‚Äî'}</p></div>
      ${acc('soc','Socialit√† e comportamento', `<p>${a.sociality||'‚Äî'}</p>`)}
      ${acc('feed','Alimentazione e caccia', `<p>${a.feeding||'‚Äî'}</p>`)}
      ${acc('repr','Riproduzione e crescita', `<p>${a.reproduction||'‚Äî'}</p>`)}
      ${acc('eco','Ruolo ecologico e predatori', `<p>${a.interactions||'‚Äî'}</p>`)}
      ${facts? acc('facts','Curiosit√†', `<ul>${facts}</ul>`) : ''}
      ${acc('hum',"Rapporto con l'uomo", `<p>${a.human||'‚Äî'}</p>`)}
      <div class="panel pad callout" style="margin-top:12px"><b>Lo sapevi che‚Ä¶</b> ${finale}</div>
    </div>
    ${quickFacts(a)}
  </div>`;
}
function curiositaTpl(){const pick=arr=>arr[Math.floor(Math.random()*arr.length)];const facts=[];for(let i=0;i<6;i++){const a=pick(ANIMALS);facts.push(`<li><b>${a.name}:</b> ${pick(a.facts||[a.description||'‚Äî'])}</li>`)}return `<div class="panel pad"><h2 style="margin-top:0">Curiosit√† casuali ‚ú®</h2><ul>${facts.join('')}</ul></div>`}
function contattiTpl(){return `<div class="panel pad"><h2 style="margin-top:0">Contatti</h2><p>Progetto didattico. Apri una issue sul repository per proposte e correzioni.</p></div>`}
function emptyTpl(){return `<div class="panel pad"><p>Nessun risultato. Prova a cambiare ricerca o filtro.</p></div>`}

/* ===== FIT INTELLIGENTE (riuso per banner e card) ===== */
function decideFitMode(img){
  const box=img.closest('.banner, .thumb'); if(!box) return 'cover';
  const rect=box.getBoundingClientRect(); const arBox=rect.width/rect.height;
  const arImg=img.naturalWidth/img.naturalHeight;
  if(arImg < arBox*0.9){ // immagine pi√π ‚Äúverticale‚Äù del contenitore
    img.classList.remove('fit-cover'); img.classList.add('fit-contain');
    // se √® una card, attiva bg blur
    const blur=box.querySelector('.bg-blur'); if(blur && img.src){ blur.style.backgroundImage=`url('${img.src}')`; blur.style.opacity=1; }
    return 'contain';
  }else{
    img.classList.remove('fit-contain'); img.classList.add('fit-cover');
    const blur=box.querySelector('.bg-blur'); if(blur){ blur.style.opacity=0; }
    return 'cover';
  }
}

/* ===== RENDER & ROUTER ===== */
function filteredItems(){const q=(state.q||'').trim().toLowerCase(); return ANIMALS.filter(a=>(!q||a._hay.includes(q))).filter(a=>(!state.cls||a.class===state.cls)).sort(by('name'))}
function applyRandomTheme(){const t=THEMES[Math.floor(Math.random()*THEMES.length)]; applyTheme(t)}
function render(){
  const container=qs('#view'); const hash=location.hash.replace('#','')||'/home'; state.route=hash;
  if(hash.startsWith('/animal/')){
    const id=hash.split('/')[2]; const a=ANIMALS.find(x=>x.id===id); if(a) applyTheme(toTheme(habClass(a.habitat||"")));
    container.innerHTML=a?detailTpl(a):`<div class="panel pad"><h2>Ops!</h2><p>Animale non trovato.</p></div>`;
    if(a){ bindTocLinks(); hydrateImages(container,a); }
    return;
  }
  if(hash==='/curiosita'){ applyRandomTheme(); container.innerHTML=curiositaTpl(); return; }
  if(hash==='/contatti'){ applyTheme('theme-prateria'); container.innerHTML=contattiTpl(); return; }
  if(hash==='/animali'||hash==='/home'){ applyRandomTheme(); container.innerHTML=listTpl(); hydrateImages(container); return; }
  applyRandomTheme(); container.innerHTML=listTpl(); hydrateImages(container);
}

/* ===== IMMAGINI: IDRATAZIONE POST-RENDER ===== */
async function hydrateImages(root=document, currentAnimal=null){
  if(!state.photos) return;
  const imgs=Array.from(root.querySelectorAll('img[data-wiki]'));
  for(const img of imgs){
    const titles=(img.getAttribute('data-wiki')||'').split('|').filter(Boolean);
    const info=await findWikiImage(titles);
    if(info && info.src){
      img.src=info.src; img.dataset.page=info.page||'';
      img.addEventListener('load', ()=>{
        const mode=decideFitMode(img);
        const btn=root.querySelector('#fitToggle'); if(btn && img.closest('.banner')) btn.textContent=`üñºÔ∏è Adatta immagine: ${mode==='contain'?'Intera':'Cover'}`;
      }, {once:true});
      const banner=img.closest('.banner');
      if(banner){
        banner.addEventListener('click', ()=>{ const url=img.dataset.page||info.src; window.open(url,'_blank','noopener'); }, {once:true});
      }
      if(currentAnimal){
        const creditBox=root.querySelector('#img-credit');
        if(creditBox){
          const pageUrl=info.page?`<a href="${info.page}" target="_blank" rel="noopener">Wikipedia (${info.lang})</a>`:'Wikipedia/Wikimedia';
          creditBox.innerHTML=`Immagine: ${info.credit} ‚Äî ${pageUrl}`;
        }
      }
    }else{
      const th=img.closest('.thumb, .banner'); if(th){ const em=th.querySelector('.emoji'); if(em) em.style.display='grid'; }
    }
  }
  // toggle manuale nel dettaglio
  const toggle=root.querySelector('#fitToggle'); const bannerImg=root.querySelector('.banner img.photo');
  if(toggle && bannerImg){
    toggle.addEventListener('click', ()=>{
      if(bannerImg.classList.contains('fit-contain')){ bannerImg.classList.remove('fit-contain'); bannerImg.classList.add('fit-cover'); toggle.textContent='üñºÔ∏è Adatta immagine: Cover'; }
      else{ bannerImg.classList.remove('fit-cover'); bannerImg.classList.add('fit-contain'); toggle.textContent='üñºÔ∏è Adatta immagine: Intera'; }
    });
    const ro=new ResizeObserver(()=>decideFitMode(bannerImg)); ro.observe(bannerImg.closest('.banner'));
  }
}

/* ===== INTERAZIONE ===== */
function goRandom(){const items=filteredItems(); if(!items.length)return; const pick=items[Math.floor(Math.random()*items.length)]; location.hash=`#/animal/${pick.id}`; showToast(`Hai pescato: ${pick.name}! üé≤`)}
function bindTocLinks(){document.querySelectorAll('.toc a[data-target]').forEach(a=>{a.addEventListener('click',(e)=>{e.preventDefault();const el=document.querySelector(a.getAttribute('data-target')); if(el){el.scrollIntoView({behavior:'smooth',block:'start'})}})})}
function setupControls(){
  document.querySelector('#q').addEventListener('input', e=>{state.q=e.target.value; render()});
  document.querySelector('#filterClass').addEventListener('change', e=>{state.cls=e.target.value; render()});
  const br=document.querySelector('#btnRandom'); if(br) br.addEventListener('click', goRandom);
  const tp=document.querySelector('#togglePhotos'); if(tp){ tp.addEventListener('change', e=>{state.photos=!!e.target.checked; render()})}
  window.addEventListener('keydown',(e)=>{if(e.key && e.key.toLowerCase()==='r' && !e.metaKey && !e.ctrlKey && !e.altKey){const a=document.activeElement; if(a&&(a.tagName==='INPUT'||a.tagName==='TEXTAREA'||a.isContentEditable))return; e.preventDefault(); goRandom();}})
}
window.addEventListener('hashchange', render);
window.addEventListener('DOMContentLoaded', ()=>{ setupControls(); render(); });
window.addEventListener('error', ()=>{ showToast('‚ö†Ô∏è Errore script: copia/incolla incompleto?'); });
</script>
</body>
</html>
